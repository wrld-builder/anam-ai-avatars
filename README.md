# –ê–≤–∞—Ç–∞—Ä‚Äë–ø—Å–∏—Ö–æ–ª–æ–≥ (Anam.ai + FastAPI + OpenAI) ‚Äî –Ω–∏–∑–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –¥–∞—ë—Ç –≥–æ—Ç–æ–≤—ã–π —Å—Ç–µ–∫ –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–æ–≤–æ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞ —Å–∞–π—Ç–µ:
- –í–∏–¥–µ–æ/–∞—É–¥–∏–æ ‚Äî **Anam.ai WebRTC SDK** (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞)
- –¢–µ–∫—Å—Ç ‚Äî **OpenAI** (–¥–≤–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞): –≤–∞—à —Ç–µ–∫—É—â–∏–π Assistants API *–∏–ª–∏* –±—ã—Å—Ç—Ä—ã–π Chat API
- –ü–µ—Ä–µ–¥–∞—á–∞ —Ç–µ–∫—Å—Ç–∞ –≤ –∞–≤–∞—Ç–∞—Ä ‚Äî **TalkMessageStream** (—Å—Ç—Ä–∏–º —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ –º–µ—Ä–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏)

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ª–∞—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

1. –ë—Ä–∞—É–∑–µ—Ä —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç **WebRTC**‚Äë—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Anam ‚Üí –≤–∏–¥–µ–æ –∞–≤–∞—Ç–∞—Ä–∞ –∏–¥—ë—Ç –Ω–∞–ø—Ä—è–º—É—é –≤ `<video>`.
2. LLM **–ù–ï** –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ Anam (llmId=CUSTOMER_CLIENT_V1) ‚Äî –º—ã —Å—Ç—Ä–∏–º–∏–º —Å–≤–æ–π —Ç–µ–∫—Å—Ç –≤ –∞–≤–∞—Ç–∞—Ä —Å –º–∏–∫—Ä–æ–∑–∞–¥–µ—Ä–∂–∫–æ–π.
3. –ë—ç–∫–µ–Ω–¥ (FastAPI) —Å—Ç—Ä–∏–º–∏—Ç —Ç–æ–∫–µ–Ω—ã –∏–∑ OpenAI (SSE) ‚Üí —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ —Å—Ä–∞–∑—É ¬´–ª—å—ë—Ç¬ª –∏—Ö –≤ `talkMessageStream`.
4. Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ **proxy_buffering off** –¥–ª—è SSE.

## –ó–∞–ø—É—Å–∫

### 1) –ë—ç–∫–µ–Ω–¥

```bash
cd backend
cp .env.example .env   # –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–ª—é—á–∏
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
./run.sh    # –∏–ª–∏: uvicorn app.main:app --host 0.0.0.0 --port 8000
```

–ü—Ä–æ–≤–µ—Ä–∫–∞:
- `GET /health` ‚Üí `{"status":"ok"}`
- `POST /api/anam/session-token` ‚Üí –æ—Ç–¥–∞—ë—Ç `{ sessionToken }`

> **–í–∞–∂–Ω–æ (Nginx)**: –¥–æ–±–∞–≤—å—Ç–µ `nginx.sse.conf` –≤ –≤–∞—à —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –±–ª–æ–∫, —á—Ç–æ–±—ã SSE –Ω–µ –±—É—Ñ–µ—Ä–∏–∑–æ–≤–∞–ª—Å—è.

### 2) –§—Ä–æ–Ω—Ç–µ–Ω–¥

```bash
cd frontend
npm i
npm run dev   # http://localhost:5173
```

–ö–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å¬ª —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é Anam, –≤–∏–¥–µ–æ –ø–æ–π–¥—ë—Ç –≤ `<video>`.  
–ü–æ–ª–µ –≤–≤–æ–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π **—Å—Ç—Ä–∏–º–∏—Ç—Å—è** –≤ –∞–≤–∞—Ç–∞—Ä (–º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞).

## –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä—Å–æ–Ω—ã

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –±—ç–∫–µ–Ω–¥–∞:
- `ANAM_AVATAR_ID`, `ANAM_VOICE_ID` ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –≤ –≥–∞–ª–µ—Ä–µ—è—Ö (—Å–º. —Å—Å—ã–ª–∫–∏ –Ω–∏–∂–µ).
- `ANAM_LLM_ID=CUSTOMER_CLIENT_V1` ‚Äî –æ—Ç–∫–ª—é—á–∞–µ—Ç –º–æ–∑–≥ Anam (–º—ã —à–ª—ë–º —Å–≤–æ–π —Ç–µ–∫—Å—Ç).
- `SYSTEM_PROMPT` ‚Äî —Å—Ç–∏–ª—å –ø—Å–∏—Ö–æ–ª–æ–≥–∞ (CBT, —ç–º–ø–∞—Ç–∏—è, –∫—Ä–∞—Ç–∫–æ—Å—Ç—å).

## –ö–∞–∫ –¥–æ–±–∏—Ç—å—Å—è –µ—â—ë –º–µ–Ω—å—à–µ–π –∑–∞–¥–µ—Ä–∂–∫–∏

- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ thread_id** (–ø–∞—Ä–∞–º–µ—Ç—Ä `thread_id` –≤ `/api/generate-assistant-response`) ‚Äî –º—ã —É–∂–µ —ç—Ç–æ –¥–µ–ª–∞–µ–º: —Ñ—Ä–æ–Ω—Ç –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç id –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç –≤ —Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã. –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å–æ–∑–¥–∞—ë—Ç —Ç—Ä–µ–¥, –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ ‚Äî –Ω–µ—Ç –ª–∏—à–Ω–µ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
- **–û—Ç–∫–ª—é—á–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã** –≤ Assistants (file_search –∏ —Ç.–ø.) ‚Äî —ç—Ç–æ —Å–Ω–∏–∂–∞–µ—Ç –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏ (—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ).
- **–ú–∏–∫—Ä–æ-–±–∞—Ç—á–∏–Ω–≥** —Ç–æ–∫–µ–Ω–æ–≤ 40‚Äì70–º—Å + ¬´—Å–±—Ä–∞—Å—ã–≤–∞—Ç—å¬ª –Ω–∞ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏ ‚Äî —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ –≤ `frontend/src/main.ts`.
- **SSE –±–µ–∑ –±—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏–∏**: Nginx `proxy_buffering off;` + –∑–∞–≥–æ–ª–æ–≤–æ–∫ `X-Accel-Buffering: no` (–≤–∫–ª—é—á–µ–Ω–æ).
- **Mute –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞** (`anamClient.muteInputAudio()`) ‚Äî –∏—Å–∫–ª—é—á–∞–µ—Ç VAD‚Äë–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è, –∫–æ–≥–¥–∞ –≤–≤–æ–¥ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π.
- **–ú–æ–¥–µ–ª—å OpenAI**: –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `gpt-4.1-mini`/`gpt-4o-mini` –≤ `/api/generate-assistant-response-fast`.

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –ø–æ Anam

- Quickstart, session‚Äëtoken, SDK `streamToVideoElement` ‚Äî —Å–º. –æ—Ñ. –¥–æ–∫–∏.  
- TalkMessageStream –¥–ª—è —Å—Ç—Ä–∏–º–∏–Ω–≥–∞ —á–∞—Å—Ç–µ–π —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî —Å–º. –æ—Ñ. –¥–æ–∫–∏.
- –°–æ–±—ã—Ç–∏—è (speech start/stop, transcription) ‚Äî —Å–º. –æ—Ñ. –¥–æ–∫–∏.

## Production
- –ü–æ—Å—Ç–∞–≤—å—Ç–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞ CDN, –±—ç–∫–µ–Ω–¥ ‚Äî –∑–∞ Nginx (—Å `nginx.sse.conf`).
- –í CORS/Referer –∑–∞–¥–∞–π—Ç–µ –≤–∞—à –¥–æ–º–µ–Ω `psychology-machines.ru`.
- –õ–æ–≥–∏–∫—É ¬´–ø—Ä–µ—Ä–≤–∞—Ç—å¬ª (`interruptPersona`) –≤—ã–∑—ã–≤–∞–π—Ç–µ –ø—Ä–∏ –Ω–æ–≤–æ–º –≤–≤–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–£–¥–∞—á–∏! üíô
